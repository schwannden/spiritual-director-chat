<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>屬靈導師聊天室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body class="bg-slate-100 min-h-screen flex flex-col">
    <header class="bg-slate-800 text-slate-50 px-6 py-4 shadow">
      <h1 class="text-xl font-semibold">屬靈導師</h1>
      <p class="text-sm text-slate-300">
        以典籍為根基，歡迎提出心裡的提問或感受。
      </p>
    </header>

    <main class="flex-1 flex flex-col max-w-5xl w-full mx-auto p-4 gap-4">
      <section
        id="messages"
        class="flex-1 overflow-y-auto bg-white rounded-xl shadow-inner border border-slate-200 p-4 space-y-4"
        aria-live="polite"
      ></section>

      <div
        id="error"
        class="hidden bg-red-100 text-red-800 border border-red-300 rounded-lg px-3 py-2 text-sm"
      ></div>

      <form
        id="chat-form"
        class="bg-white rounded-xl shadow border border-slate-200 p-4 space-y-3"
      >
        <div class="space-y-2">
          <label for="collection-select" class="block text-sm font-medium text-slate-700"
            >選擇參考書集</label
          >
          <select
            id="collection-select"
            class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent bg-white"
          >
            <option value="on-living-well">畢德生（On Living Well）</option>
            <option value="imitatio-christi">托馬斯·肯皮斯（Imitatio Christi）</option>
            <option value="both" selected>兩個書集</option>
          </select>
        </div>
        <div class="space-y-2">
          <label for="response-length" class="block text-sm font-medium text-slate-700"
            >回應長度</label
          >
          <select
            id="response-length"
            class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent bg-white"
          >
            <option value="short">短（約 300 字元）</option>
            <option value="medium" selected>中（約 500 字元）</option>
            <option value="long">長（約 1000 字元）</option>
          </select>
        </div>
        <label for="message-input" class="block text-sm font-medium text-slate-700"
          >分享你的提問或感受</label
        >
        <textarea
          id="message-input"
          rows="4"
          class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent resize-y"
          placeholder="今天想在哪裡得到指引或鼓勵？"
          required
        ></textarea>
        <div class="flex items-center justify-between">
          <p id="status" class="text-sm text-slate-500 h-5"></p>
          <button
            id="send-button"
            type="submit"
            class="inline-flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-600 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span>送出</span>
            <svg
              id="loading-icon"
              class="hidden animate-spin h-4 w-4 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
          </button>
        </div>
      </form>
    </main>

    <script>
      const form = document.getElementById("chat-form");
      const input = document.getElementById("message-input");
      const messagesEl = document.getElementById("messages");
      const errorEl = document.getElementById("error");
      const statusEl = document.getElementById("status");
      const sendButton = document.getElementById("send-button");
      const loadingIcon = document.getElementById("loading-icon");
      const collectionSelect = document.getElementById("collection-select");
      const responseLengthSelect = document.getElementById("response-length");
      let isComposing = false;

      const COLLECTION_LABELS = {
        "on-living-well": "畢德生（On Living Well）",
        "imitatio-christi": "托馬斯·肯皮斯（Imitatio Christi）",
      };
      const RESPONSE_LENGTH_LABELS = {
        short: "短",
        medium: "中",
        long: "長",
      };

      const conversation = [];

      function renderMessages() {
        messagesEl.replaceChildren();

        conversation.forEach((message) => {
          const isUser = message.role === "user";
          const wrapper = document.createElement("div");
          wrapper.className = [
            "max-w-2xl",
            "rounded-xl",
            "px-4",
            "py-3",
            "shadow",
            isUser
              ? "bg-slate-800 text-slate-50 ml-auto"
              : "bg-slate-100 text-slate-800 mr-auto",
          ].join(" ");

          const content = document.createElement(message.role === "assistant" ? "div" : "p");
          if (message.role === "assistant") {
            content.className = "prose prose-slate max-w-none";
            try {
              const html = window.marked ? window.marked.parse(message.content) : message.content;
              content.innerHTML = html;
            } catch (error) {
              content.textContent = message.content;
            }
          } else {
            content.className = "whitespace-pre-wrap leading-relaxed";
            content.textContent = message.content;
          }
          wrapper.appendChild(content);

          if (message.sources && message.sources.length) {
            const details = document.createElement("details");
            details.className = "mt-3 text-xs text-slate-600 border-t border-slate-200 pt-2";

            const summary = document.createElement("summary");
            summary.className = "cursor-pointer select-none text-slate-700 font-medium";
            summary.textContent = "參考來源（點擊展開）";
            details.appendChild(summary);

            const sourcesList = document.createElement("ul");
            sourcesList.className = "mt-2 space-y-1";
            message.sources.forEach((source) => {
              const item = document.createElement("li");
              const label = source.collection_label || source.collection || "書集";
              const filename = source.filename || "未知";
              const distance =
                typeof source.distance === "number" ? ` · 相似度 ${source.distance.toFixed(3)}` : "";
              item.textContent = `${label} · ${filename}${distance}`;
              sourcesList.appendChild(item);
            });

            details.appendChild(sourcesList);
            wrapper.appendChild(details);
          }

          messagesEl.appendChild(wrapper);
        });

        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function setError(message) {
        if (message) {
          errorEl.textContent = message;
          errorEl.classList.remove("hidden");
        } else {
          errorEl.textContent = "";
          errorEl.classList.add("hidden");
        }
      }

      function setLoading(isLoading, statusMessage = "") {
        if (isLoading) {
          sendButton.disabled = true;
          loadingIcon.classList.remove("hidden");
          statusEl.textContent = statusMessage || "聆聽中...";
        } else {
          sendButton.disabled = false;
          loadingIcon.classList.add("hidden");
          statusEl.textContent = statusMessage || "";
        }
      }

      function getSelectedCollections() {
        const value = collectionSelect.value;
        if (value === "both") {
          return ["on-living-well", "imitatio-christi"];
        }
        return [value];
      }

      function getSelectedCollectionsLabel() {
        const value = collectionSelect.value;
        if (value === "both") {
          return "畢德生（On Living Well） + 托馬斯·肯皮斯（Imitatio Christi）";
        }
        return COLLECTION_LABELS[value] || "所選書集";
      }

      function getResponseLength() {
        const value = responseLengthSelect.value;
        if (value === "short" || value === "medium" || value === "long") {
          return value;
        }
        return "medium";
      }

      function payloadMessages() {
        return conversation
          .filter((message) => message.role === "user" || message.role === "assistant")
          .map(({ role, content }) => ({ role, content }));
      }

      async function sendMessage(event) {
        event.preventDefault();
        setError("");

        const content = input.value.trim();
        if (!content) {
          return;
        }

        conversation.push({ role: "user", content });
        renderMessages();
        input.value = "";
        input.focus();

        const collections = getSelectedCollections();
        const selectionLabel = getSelectedCollectionsLabel();
        const responseLength = getResponseLength();
        const responseLengthLabel = RESPONSE_LENGTH_LABELS[responseLength] || responseLength;

        setLoading(true, `正在 ${selectionLabel} 中檢索，準備一個${responseLengthLabel}回應...`);

        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              messages: payloadMessages(),
              collections,
              response_length: responseLength,
            }),
          });

          if (!response.ok) {
            const detail = await response.text();
            throw new Error(detail || "聊天服務發生錯誤。");
          }

          const data = await response.json();
          conversation.push({
            role: "assistant",
            content: data.reply,
            sources: data.sources ?? [],
          });
          renderMessages();
        } catch (error) {
          setError(error.message || "目前無法連線到聊天服務。");
        } finally {
          setLoading(false);
        }
      }

      form.addEventListener("submit", sendMessage);

      input.addEventListener("compositionstart", () => {
        isComposing = true;
      });

      input.addEventListener("compositionend", () => {
        isComposing = false;
      });

      input.addEventListener("keydown", (event) => {
        if (event.isComposing || isComposing) {
          return;
        }
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          form.requestSubmit();
        }
      });
    </script>
  </body>
</html>
